<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NavBot // Vision System</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap"
    rel="stylesheet" />
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- NavX Styles -->
  <link rel="stylesheet" href="navx/styles.css" />
  <link rel="stylesheet" href="navx/dashboard.css" />

  <style>
    /* --- LAYOUT REDESIGN --- */
    :root {
      --sidebar-width: 550px;
      --header-height: 60px;
    }

    body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #05060a;
    }

    /* Global Nav (Top) */
    nav {
      height: var(--header-height);
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-color);
      background: rgba(5, 6, 10, 0.95);
      z-index: 1000;
    }

    /* Main Grid */
    .main-layout {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      height: calc(100vh - var(--header-height));
      overflow: hidden;
    }

    /* --- SIDEBAR --- */
    .sidebar-panel {
      background: rgba(10, 12, 16, 0.95);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .panel-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .section-header {
      font-family: "Oswald", sans-serif;
      font-size: 0.9rem;
      color: var(--text-muted);
      letter-spacing: 1.5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 4px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Camera Module (Integrated) */
    .camera-module {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      /* Standard webcam aspect */
      background: #000;
      border: 1px solid var(--border-color);
      overflow: hidden;
      border-radius: 4px;
    }

    .camera-module img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* --- Modal Styles --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: #0a0a0a;
      border: 1px solid var(--primary-color);
      width: 600px;
      padding: 2rem;
      position: relative;
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
    }

    .modal-content::before {
      content: "";
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--primary-color), transparent, var(--primary-color));
      z-index: -1;
      opacity: 0.3;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid #333;
      padding-bottom: 1rem;
    }

    .modal-title {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      color: var(--primary-color);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .option-card {
      background: #111;
      border: 1px solid #333;
      padding: 1.5rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .option-card:hover {
      border-color: var(--primary-color);
      background: #1a1a1a;
    }

    .option-card.selected {
      border-color: var(--primary-color);
      background: rgba(0, 255, 136, 0.1);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
    }

    .option-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #888;
    }

    .option-card.selected .option-icon {
      color: var(--primary-color);
    }

    .option-title {
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .option-desc {
      font-size: 0.7rem;
      color: #aaa;
      /* Lighter gray for better readability */
      line-height: 1.4;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 1rem;
    }

    .calc-btn {
      background: #00ff88;
      /* Explicit Neon Green */
      color: #000;
      border: none;
      padding: 0.8rem 2rem;
      font-family: 'Space Mono', monospace;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
      transition: all 0.2s ease;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }

    .calc-btn:hover {
      background: #fff;
      box-shadow: 0 0 20px var(--primary-color);
    }

    .calc-btn:disabled {
      background: #333;
      color: #fff;
      /* White text */
      opacity: 0.5;
      /* Dimmed via opacity instead of dark color */
      cursor: not-allowed;
      box-shadow: none;
      border: 1px solid #555;
    }

    /* Processing Overlay */
    .processing-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 10, 10, 0.95);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .processing-overlay.active {
      display: flex;
    }

    .processing-text {
      font-family: 'Space Mono', monospace;
      color: var(--primary-color);
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .camera-module canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    /* Placeholder for failed stream */
    .camera-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      /* Hidden by default */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: var(--text-muted);
      text-align: center;
    }

    .camera-placeholder i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--accent-fast);
    }

    .camera-placeholder span {
      font-family: "Oswald", sans-serif;
      letter-spacing: 2px;
      font-size: 1.2rem;
      color: white;
    }

    /* Battery Widget */
    .battery-widget {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-color);
      padding: 12px;
      border-radius: 4px;
    }

    .battery-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .battery-bar-container {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }

    .battery-bar-fill {
      height: 100%;
      width: 0%;
      /* JS will update */
      background: var(--accent-safe);
      transition: width 0.5s ease, background 0.3s ease;
    }

    .battery-value {
      font-family: "Space Mono", monospace;
      color: white;
    }

    /* Navigation Modes (Compact) */
    .mode-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .mode-btn {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-color);
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mode-btn:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .mode-btn.active {
      border-color: var(--accent-safe);
      background: rgba(21, 255, 185, 0.1);
    }

    .mode-btn.active .mode-name {
      color: var(--accent-safe);
    }

    .mode-name {
      font-family: "Oswald", sans-serif;
      color: white;
      letter-spacing: 1px;
    }

    .mode-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* --- MAP AREA --- */
    .map-panel {
      position: relative;
      background: radial-gradient(circle at 50% 50%,
          rgba(20, 30, 40, 0.4),
          #05060a 90%);
      overflow: hidden;
    }

    #nav-map {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Floating Overlay on Map */
    .map-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
    }

    .overlay-chip {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(4px);
      padding: 8px 16px;
      color: white;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .overlay-chip i {
      color: var(--accent-safe);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 300px 1fr;
      }

      :root {
        --sidebar-width: 300px;
      }
    }

    @media (max-width: 768px) {
      .main-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .sidebar-panel {
        height: 300px;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
    }

    /* Zone Visibility */
    .scenic-zone,
    .comfort-zone,
    .comfort-zone-corridor {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .scenic-zone.active,
    .comfort-zone.active,
    .comfort-zone-corridor.active {
      opacity: 1;
    }

    /* Fix: Hide inactive route paths completely (override dashboard.css) */
    .route-path {
      opacity: 0 !important;
    }

    .route-path.active {
      opacity: 1 !important;
    }

    /* Collapsible Overlay Transitions */
    .map-overlay {
      transition: gap 0.4s ease;
    }

    .map-overlay .overlay-chip {
      transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
      opacity: 1;
      transform: translateX(0);
      max-width: 200px;
      /* Max width for expansion */
      padding: 8px 16px;
      margin: 0;
      overflow: hidden;
      white-space: nowrap;
    }

    /* Toggle Button stays visible */
    .map-overlay .overlay-chip.toggle-btn {
      z-index: 10;
    }

    /* Collapsed State */
    .map-overlay.collapsed {
      gap: 0;
      /* Remove gap between items */
    }

    .map-overlay.collapsed .overlay-chip:not(.toggle-btn) {
      opacity: 0;
      transform: translateX(-20px);
      max-width: 0;
      padding: 8px 0;
      /* Remove horizontal padding */
      border-width: 0;
      pointer-events: none;
    }

    /* Mode Details Banner */
    #mode-details {
      margin-top: 16px;
      border: 1px solid var(--border-color);
      background: rgba(0, 0, 0, 0.4);
      padding: 16px;
      display: none;
      /* Hidden until mode selected */
      animation: fadeIn 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    #mode-details.active {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mode-banner-header {
      font-family: "Oswald", sans-serif;
      font-size: 1.1rem;
      letter-spacing: 1px;
      color: white;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-banner-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .mode-stat-bar {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    .stat-track {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      width: 100%;
      border-radius: 2px;
    }

    .stat-fill {
      height: 100%;
      background: var(--accent-safe);
      width: 0%;
      transition: width 0.5s ease, background 0.3s ease;
      border-radius: 2px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- Custom Cursor -->
  <div id="custom-cursor"></div>
  <!-- CRT Scanline Overlay -->
  <div class="crt-overlay"></div>

  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <a href="navx/index.html" class="logo">NAV//X</a>
      <ul class="nav-links">
        <li><a href="navx/index.html#hero">00_Home</a></li>
        <li><a href="navx/dashboard.html">04_Dashboard</a></li>
        <li>
          <a href="camera.html" style="color: white; text-decoration: line-through">05_Vision</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Layout -->
  <div class="main-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar-panel">

      <!-- 1. Vision Feed Module -->
      <div class="panel-section">
        <div class="section-header">
          <span>LIVE FEED</span>
          <span id="cam-status" style="font-size: 0.7rem; color: var(--accent-safe)">● ONLINE</span>
        </div>
        <div class="camera-module">
          <!-- Stream Image -->
          <img id="camera-stream" src="http://172.20.10.10:8080/?action=stream" alt="Stream" />
          <!-- AI Overlay -->
          <canvas id="ai-layer"></canvas>
          <!-- Error Placeholder -->
          <div id="cam-placeholder" class="camera-placeholder">
            <i class="fas fa-video-slash"></i>
            <span>NAV//X<br><span style="font-size:0.8rem; opacity:0.7">SIGNAL LOST</span></span>
          </div>
        </div>
      </div>

      <!-- 2. System Status (Battery & Weather) -->
      <div class="panel-section">
        <div class="section-header">SYSTEM STATUS</div>

        <!-- Battery Widget -->
        <div class="battery-widget">
          <div class="battery-header">
            <span>BATTERY LEVEL</span>
            <span id="battery-val" class="battery-value">--%</span>
          </div>
          <div class="battery-bar-container">
            <div id="battery-fill" class="battery-bar-fill"></div>
          </div>
        </div>

        <!-- Weather Widget (Restored) -->
        <div class="battery-widget" style="margin-top: 8px;">
          <div class="battery-header" style="margin-bottom: 4px;">
            <span>INCHEON WX</span>
            <span id="weather-updated" style="font-size: 0.7rem">--:--</span>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <i id="weather-icon" class="fas fa-sun" style="color: var(--accent-safe)"></i>
              <span id="weather-temp" style="font-family: 'Oswald'; font-size: 1.2rem; color: white;">--°</span>
            </div>
            <div style="text-align: right; font-size: 0.75rem; color: var(--text-muted);">
              <div id="weather-desc">Loading...</div>
              <div id="weather-wind">-- km/h</div>
            </div>
          </div>
        </div>

        <!-- Connection Status -->
        <div class="battery-widget"
          style="padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
          <span style="font-size: 0.8rem; color: var(--text-muted)">AI SERVER</span>
          <span id="server-status" style="font-size: 0.8rem; color: var(--accent-fast)">DISCONNECTED</span>
        </div>
      </div>

      <!-- 3. Navigation Modes -->
      <div class="panel-section">
        <div class="section-header">NAVIGATION MODE</div>
        <div class="mode-grid">
          <div class="mode-btn active" onclick="setRoute('fastest')" data-mode="fastest">
            <span class="mode-name">FASTEST</span>
            <span class="mode-meta">12 min</span>
          </div>
          <div class="mode-btn" onclick="setRoute('scenic')" data-mode="scenic">
            <span class="mode-name">SCENIC</span>
            <span class="mode-meta">24 min</span>
          </div>
          <div class="mode-btn" onclick="setRoute('comfort')" data-mode="comfort">
            <span class="mode-name">COMFORT</span>
            <span class="mode-meta">18 min</span>
          </div>
        </div>

        <!-- Mode Details Banner -->
        <div id="mode-details">
          <div class="mode-banner-header" id="md-header">
            <i class="fas fa-info-circle"></i> <span>--</span>
          </div>
          <div class="mode-banner-desc" id="md-desc">--</div>

          <!-- Stats -->
          <div class="mode-stat-bar">
            <div class="stat-label"><span>EFFICIENCY</span><span id="md-eff-val">0%</span></div>
            <div class="stat-track">
              <div class="stat-fill" id="md-eff-fill"></div>
            </div>
          </div>
          <div class="mode-stat-bar">
            <div class="stat-label"><span>SAFETY</span><span id="md-safe-val">0%</span></div>
            <div class="stat-track">
              <div class="stat-fill" id="md-safe-fill"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Metrics (Removed, moved to map) -->
    </aside>

    <!-- MAP AREA -->
    <main class="map-panel">
      <div class="map-overlay" id="telemetry-overlay">
        <!-- Toggle Button -->
        <div class="overlay-chip toggle-btn" onclick="toggleTelemetry()" style="cursor: pointer; padding: 8px 12px;">
          <i class="fas fa-eye" id="tele-toggle-icon"></i>
        </div>

        <div class="overlay-chip" id="map-status-chip">
          <i class="fas fa-shield-alt"></i> ROUTE STABLE
        </div>
        <div class="overlay-chip">
          <i class="fas fa-location-arrow"></i> INCHEON
        </div>
        <!-- Moved Telemetry -->
        <div class="overlay-chip">
          <span
            style="color: var(--text-muted); margin-right: 8px; font-size: 0.75rem; letter-spacing: 1px;">RISK</span>
          <span id="tele-risk" style="font-family: 'Oswald'; font-size: 1.1rem; color: white;">--</span>
        </div>
        <div class="overlay-chip">
          <span
            style="color: var(--text-muted); margin-right: 8px; font-size: 0.75rem; letter-spacing: 1px;">SPEED</span>
          <span style="font-family: 'Oswald'; font-size: 1.1rem; color: white;">
            <span id="tele-speed">--</span> <span style="font-size:0.8rem">km/h</span>
          </span>
        </div>
      </div>

      <!-- SVG Map (Same as before, just ensuring it fills) -->
      <svg id="nav-map" viewBox="-300 -200 1600 1200" preserveAspectRatio="xMidYMid slice">
        <!-- Map Background -->
        <rect x="-3000" y="-3000" width="8000" height="8000" class="map-bg" />
        <rect x="0" y="0" width="800" height="800" class="map-bg" opacity="0.85" />

        <!-- Zones -->
        <path d="M -400 720 L 780 720 L 780 840 L -400 840 Z" class="scenic-zone" />
        <rect x="-100" y="-60" width="1300" height="80" class="comfort-zone" />
        <rect x="-60" y="-400" width="80" height="1600" class="comfort-zone-corridor" />

        <!-- Buildings (Simplified for brevity, but keeping structure) -->
        <g class="buildings">
          <!-- We reuse the building logic from previous file, abbreviated here for clarity but fully functional in logic -->
          <!-- Block 1 -->
          <g transform="translate(160,160)" data-building data-x="200" data-y="200">
            <path d="M 20 20 L 100 20 L 100 100 L 20 100 Z" class="building-3d" transform="translate(-15,15)" />
            <rect width="80" height="80" class="building" />
          </g>
          <!-- Block 2 -->
          <g transform="translate(460,620)" data-building data-x="500" data-y="660">
            <path d="M 0 0 L 100 0 L 100 100 L 0 100 Z" class="building-3d" transform="translate(-15,15)" />
            <rect width="100" height="100" class="building" />
          </g>
          <!-- More buildings would go here, keeping it clean for this rewrite -->
          <g transform="translate(600,40)" data-building data-x="630" data-y="70">
            <rect width="70" height="70" class="building" />
          </g>
          <g transform="translate(90,600)" data-building data-x="120" data-y="630">
            <rect width="80" height="80" class="building" />
          </g>
          <g transform="translate(320,120)" data-building data-x="360" data-y="160">
            <rect width="80" height="80" class="building" />
          </g>
        </g>

        <!-- Roads -->
        <g>
          <!-- Diagonal -->
          <path d="M -200 1000 L 1000 -200" stroke-width="80" class="road-casing" />
          <path d="M -200 1000 L 1000 -200" stroke-width="60" class="road-core" />
          <path d="M -200 1000 L 1000 -200" class="road-centerline" />
        </g>
        <g>
          <!-- Vertical/Horizontal -->
          <path d="M 20 2000 L 20 -500" stroke-width="60" class="road-casing" />
          <path d="M 20 2000 L 20 -500" stroke-width="40" class="road-core" />
          <path d="M -500 20 L 2000 20" stroke-width="60" class="road-casing" />
          <path d="M -500 20 L 2000 20" stroke-width="40" class="road-core" />
          <path d="M 20 2000 L 20 -500" class="road-centerline" />
          <path d="M -500 20 L 2000 20" class="road-centerline" />
        </g>
        <g>
          <!-- Scenic Route Roads -->
          <path d="M -500 780 L 2000 780" stroke-width="60" class="road-casing" />
          <path d="M -500 780 L 2000 780" stroke-width="40" class="road-core" />
          <path d="M 780 2000 L 780 -500" stroke-width="60" class="road-casing" />
          <path d="M 780 2000 L 780 -500" stroke-width="40" class="road-core" />
          <path d="M -500 780 L 2000 780" class="road-centerline" />
          <path d="M 780 2000 L 780 -500" class="road-centerline" />
        </g>

        <!-- Routes -->
        <!-- Routes -->
        <path id="path-fastest" class="route-path active" d="M 20 780 L 780 20" stroke="#ff0055" />
        <path id="path-comfort" class="route-path" d="M 20 780 L 20 20 L 780 20" stroke="#00ffaa" />
        <path id="path-scenic" class="route-path" d="M 20 780 L 780 780 L 780 20" stroke="#00aaff" />

        <!-- POIs -->
        <g class="pois">
          <g id="marker-home" transform="translate(20,780)">
            <circle r="8" class="poi-marker" fill="#ffcc00" stroke="white" stroke-width="2" />
            <text x="12" y="3" class="poi-label" fill="#ffcc00" style="font-weight:bold; font-size:12px;">HOME</text>
          </g>
          <g id="marker-dest" transform="translate(780,20)">
            <circle r="8" class="poi-marker" fill="#00aaff" stroke="white" stroke-width="2" />
            <text x="12" y="3" class="poi-label" fill="#00aaff"
              style="font-weight:bold; font-size:12px;">DESTINATION</text>
          </g>
        </g>

        <!-- Street Labels -->
        <text x="400" y="380" class="street-label" transform="rotate(-45,400,380)">TRANSIT ARTERY 01</text>
        <text x="50" y="400" class="street-label" transform="rotate(-90,50,400)">COMMERCE BLVD</text>

        <!-- Robot Agent -->
        <g id="agent" class="nav-agent">
          <g class="agent-car">
            <rect class="car-body" x="-14" y="-8" width="28" height="16" rx="4" />
            <rect class="car-cabin" x="-10" y="-6" width="10" height="12" rx="2" />
            <circle class="car-light" cx="10" cy="-4" r="2" />
            <circle class="car-light" cx="10" cy="4" r="2" />
            <path class="car-shadow" d="M -16 9 L 16 9" />
          </g>
        </g>
      </svg>
    </main>
  </div>

  <!-- Route Preference Modal -->
  <div id="route-modal" class="modal-overlay">
    <div class="modal-content">
      <!-- Processing Overlay -->
      <div id="processing-view" class="processing-overlay">
        <div class="loader"></div> <!-- Reusing existing loader style if available, or simple text -->
        <div style="color: var(--primary-color); font-size: 2rem;">
          <i class="fas fa-cog fa-spin"></i>
        </div>
        <div id="processing-text" class="processing-text">ANALYZING TOPOLOGY...</div>
      </div>

      <div class="modal-header">
        <div>
          <div id="modal-status-msg"
            style="font-family: 'Space Mono'; font-size: 0.9rem; color: var(--accent-safe); margin-bottom: 0.5rem; display: none;">
            // SYSTEM_MSG: SAFELY ARRIVED
          </div>
          <div class="modal-title">Route Optimization Strategy</div>
        </div>
        <div style="font-family: 'Space Mono'; font-size: 0.8rem; color: #666;">ID: #REQ-9921</div>
      </div>

      <div class="modal-grid">
        <!-- Option 1: Fastest -->
        <div class="option-card" onclick="selectOption('fastest', this)">
          <div class="option-icon"><i class="fas fa-bolt"></i></div>
          <div class="option-title">FASTEST</div>
          <div class="option-desc">Optimized for speed. Direct path routing with minimal deviation.</div>
        </div>

        <!-- Option 2: Scenic -->
        <div class="option-card" onclick="selectOption('scenic', this)">
          <div class="option-icon"><i class="fas fa-image"></i></div>
          <div class="option-title">SCENIC</div>
          <div class="option-desc">Relaxed pace. Prioritizes visual experience and environmental scanning.</div>
        </div>

        <!-- Option 3: Comfort -->
        <div class="option-card" onclick="selectOption('comfort', this)">
          <div class="option-icon"><i class="fas fa-couch"></i></div>
          <div class="option-title">COMFORT</div>
          <div class="option-desc">Smoothest ride. Minimizes acceleration forces for delicate cargo.</div>
        </div>
      </div>

      <div class="modal-footer">
        <div style="font-family: 'Space Mono'; font-size: 0.7rem; color: #444;">AWAITING INPUT...</div>
        <button id="calc-btn" class="calc-btn" onclick="calculateRoute()" disabled>CALCULATE ROUTE</button>
      </div>
    </div>
  </div>

  <script>
    // --- Custom Cursor ---
    const cursor = document.getElementById("custom-cursor");
    document.addEventListener("mousemove", (e) => {
      cursor.style.left = e.clientX + "px";
      cursor.style.top = e.clientY + "px";
    });

    // --- Stream Error Handling ---
    // --- Stream Health Monitor & Auto-Reconnect ---
    const STREAM_URL = "http://172.20.10.10:8080/?action=stream";
    const SNAPSHOT_URL = "http://172.20.10.10:8080/?action=snapshot";
    let isStreamOnline = true; // Assume online initially, let checks correct it

    // Periodically check if the camera is actually alive
    setInterval(() => {
      const tester = new Image();
      tester.onload = () => {
        // Camera is responding
        if (!isStreamOnline) {
          console.log("Health check passed: Stream returned!");
          isStreamOnline = true;
          handleStreamSuccess();
          // Force reconnect the main stream
          document.getElementById("camera-stream").src = `${STREAM_URL}&t=${Date.now()}`;
        }
      };
      tester.onerror = () => {
        // Camera is dead
        // We check if it WAS online to avoid spamming logs/UI updates
        // But we also force it if the UI is currently showing the image (frozen frame case)
        const img = document.getElementById("camera-stream");
        if (isStreamOnline || img.style.display !== "none") {
          console.log("Health check failed: Stream lost!");
          isStreamOnline = false;
          handleStreamError();
        }
      };
      // Add timestamp to bypass cache
      tester.src = `${SNAPSHOT_URL}&t=${Date.now()}`;
    }, 5000); // Check every 5 seconds

    function handleStreamError() {
      const img = document.getElementById("camera-stream");
      const placeholder = document.getElementById("cam-placeholder");
      const status = document.getElementById("cam-status");

      // Update UI to "Lost" state
      img.style.display = "none";
      placeholder.style.display = "flex";

      if (status) {
        status.textContent = "● SIGNAL LOST";
        status.style.color = "var(--accent-fast)";
      }

      isStreamOnline = false;
    }

    function handleStreamSuccess() {
      const img = document.getElementById("camera-stream");
      const placeholder = document.getElementById("cam-placeholder");
      const status = document.getElementById("cam-status");

      // Restore UI
      img.style.display = "block";
      placeholder.style.display = "none";

      if (status) {
        status.textContent = "● ONLINE";
        status.style.color = "var(--accent-safe)";
      }

      isStreamOnline = true;
    }

    /* --- Map & Navigation Logic --- */
    const routes = {
      fastest: { id: "path-fastest", baseRisk: 6.5, speed: 80 },
      scenic: { id: "path-scenic", baseRisk: 1.2, speed: 45 },
      comfort: { id: "path-comfort", baseRisk: 2.5, speed: 55 },
    };
    let activeMode = "fastest";

    const modeData = {
      fastest: {
        title: "SPEED PRIORITY",
        desc: "Optimized for minimum travel time. Higher risk tolerance allowed in non-residential zones.",
        eff: 95,
        safe: 60,
        color: "#ff0055"
      },
      scenic: {
        title: "SCENIC ROUTE",
        desc: "Maximizes coastal and park views. Speed limited for passenger comfort.",
        eff: 40,
        safe: 98,
        color: "#00aaff"
      },
      comfort: {
        title: "PASSENGER COMFORT",
        desc: "Balanced profile with strict G-force limits. Smoothest ride quality.",
        eff: 70,
        safe: 90,
        color: "#00ffaa"
      }
    };

    function setRoute(mode) {
      activeMode = mode;

      // Update Buttons
      document.querySelectorAll(".mode-btn").forEach(btn => {
        btn.classList.remove("active");
        if (btn.dataset.mode === mode) btn.classList.add("active");
      });

      // Update Paths
      document.querySelectorAll(".route-path").forEach(p => p.classList.remove("active"));
      const path = document.getElementById(routes[mode].id);
      if (path) path.classList.add("active");

      // Update Zones
      document.querySelectorAll(".scenic-zone, .comfort-zone, .comfort-zone-corridor").forEach(el => el.classList.remove("active"));

      if (mode === 'scenic') {
        document.querySelectorAll(".scenic-zone").forEach(el => el.classList.add("active"));
      } else if (mode === 'comfort') {
        document.querySelectorAll(".comfort-zone, .comfort-zone-corridor").forEach(el => el.classList.add("active"));
      }

      updateTelemetry();
      updateModeBanner(mode);
    }

    function updateModeBanner(mode) {
      const details = document.getElementById("mode-details");
      const data = modeData[mode];

      if (!data) return;

      details.classList.add("active");

      // Update Header Color
      const headerIcon = details.querySelector(".mode-banner-header i");
      headerIcon.style.color = data.color;

      // Update Text
      const headerSpan = document.getElementById("md-header").querySelector("span");
      headerSpan.innerText = data.title;
      headerSpan.style.color = data.color;

      document.getElementById("md-desc").innerText = data.desc;

      // Update Bars
      document.getElementById("md-eff-val").innerText = data.eff + "%";
      document.getElementById("md-eff-fill").style.width = data.eff + "%";
      document.getElementById("md-eff-fill").style.background = data.color;

      document.getElementById("md-safe-val").innerText = data.safe + "%";
      document.getElementById("md-safe-fill").style.width = data.safe + "%";
      document.getElementById("md-safe-fill").style.background = data.color;

      // Border accent
      details.style.borderLeft = `4px solid ${data.color}`;
    }

    function updateTelemetry() {
      const route = routes[activeMode];
      const risk = route.baseRisk;
      const speed = route.speed;

      document.getElementById("tele-risk").innerText = risk;
      document.getElementById("tele-speed").innerText = speed;

      // Update Map Chip
      const chip = document.getElementById("map-status-chip");
      if (risk > 5) {
        chip.innerHTML = '<i class="fas fa-exclamation-triangle"></i> HIGH RISK';
        chip.style.color = "var(--accent-fast)";
        chip.style.borderColor = "var(--accent-fast)";
      } else {
        chip.innerHTML = '<i class="fas fa-shield-alt"></i> ROUTE STABLE';
        chip.style.color = "var(--accent-safe)";
        chip.style.borderColor = "rgba(255,255,255,0.1)";
      }
    }

    function toggleTelemetry() {
      const overlay = document.getElementById("telemetry-overlay");
      const icon = document.getElementById("tele-toggle-icon");
      overlay.classList.toggle("collapsed");

      if (overlay.classList.contains("collapsed")) {
        icon.className = "fas fa-eye-slash";
      } else {
        icon.className = "fas fa-eye";
      }
    }


    // --- Agent Animation ---
    function animateAgentLoop() {
      const agent = document.getElementById("agent");
      let progress = 0;
      function step() {
        const path = document.getElementById(routes[activeMode].id);
        if (path && agent) {
          const len = path.getTotalLength();
          progress += routes[activeMode].speed * 0.03;
          if (progress > len) progress = 0;

          const pt = path.getPointAtLength(progress);
          const nextPt = path.getPointAtLength(Math.min(progress + 10, len));
          const angle = Math.atan2(nextPt.y - pt.y, nextPt.x - pt.x) * 180 / Math.PI;

          agent.setAttribute("transform", `translate(${pt.x}, ${pt.y}) rotate(${angle})`);
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    setRoute("fastest");
    setRoute("fastest");
    // animateAgentLoop(); // Disabled to prevent random movement

    // --- Weather Logic ---
    async function refreshWeather() {
      const url = "https://api.open-meteo.com/v1/forecast?latitude=37.456&longitude=126.705&current_weather=true&timezone=Asia%2FSeoul";
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Weather API Error");
        const data = await res.json();
        const cw = data.current_weather;

        document.getElementById("weather-temp").textContent = Math.round(cw.temperature) + "°";
        document.getElementById("weather-wind").textContent = Math.round(cw.windspeed) + " km/h";

        // Decode Code
        let label = "Clear";
        let icon = "fa-sun";
        const code = cw.weathercode;
        if ([1, 2, 3].includes(code)) { label = "Clouds"; icon = "fa-cloud"; }
        else if ([45, 48].includes(code)) { label = "Fog"; icon = "fa-smog"; }
        else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) { label = "Rain"; icon = "fa-cloud-showers-heavy"; }
        else if ([71, 73, 75, 77, 85, 86].includes(code)) { label = "Snow"; icon = "fa-snowflake"; }

        document.getElementById("weather-desc").textContent = label;
        document.getElementById("weather-icon").className = `fas ${icon}`;

        const t = new Date();
        document.getElementById("weather-updated").textContent = t.toLocaleTimeString("en-US", { hour12: false, hour: '2-digit', minute: '2-digit' });

      } catch (e) {
        console.error(e);
        document.getElementById("weather-desc").textContent = "Offline";
      }
    }
    refreshWeather();
    setInterval(refreshWeather, 300000); // 5 mins

    // --- WebSocket & Battery ---
    const canvas = document.getElementById("ai-layer");
    const ctx = canvas.getContext("2d");
    const img = document.getElementById("camera-stream");

    // Attach listeners here to avoid ReferenceError with inline attributes
    img.onload = handleStreamSuccess;
    img.onerror = handleStreamError;

    const serverStatus = document.getElementById("server-status");
    const batteryVal = document.getElementById("battery-val");
    const batteryFill = document.getElementById("battery-fill");

    let ws = null;

    // Map Scaling Configuration
    // Aligning (0,0) ROS to the "HOME" position (20, 780) in SVG
    const MAP_SCALE = 100; // Pixels per meter
    const MAP_OFFSET_X = 20; // Bottom Left X
    const MAP_OFFSET_Y = 780; // Bottom Left Y

    function connectWS() {
      ws = new WebSocket("ws://localhost:8765");

      ws.onopen = () => {
        serverStatus.textContent = "CONNECTED";
        serverStatus.style.color = "var(--accent-safe)";
      };

      ws.onclose = () => {
        serverStatus.textContent = "DISCONNECTED";
        serverStatus.style.color = "var(--accent-fast)";
        setTimeout(connectWS, 2000);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // Update Battery
        if (data.battery !== undefined) {
          if (data.battery === "ERR" || data.battery === "--") {
            batteryVal.textContent = "ERR";
            batteryFill.style.width = "0%";
            batteryFill.style.background = "var(--accent-fast)";
          } else {
            const pct = parseInt(data.battery);
            batteryVal.textContent = pct + "%";
            batteryFill.style.width = pct + "%";

            if (pct < 20) batteryFill.style.background = "var(--accent-fast)";
            else if (pct < 50) batteryFill.style.background = "#ffcc00";
            else batteryFill.style.background = "var(--accent-safe)";
          }
        }

        // Update Navigation
        if (data.nav_status) {
          updateAgentPosition(data.nav_status);
        }

        // Draw AI
        drawAI(data);
      };
    }

    // --- Modal Logic ---
    let selectedMode = null;
    let isModalOpen = false;

    function showRouteModal(message = null) {
      if (isModalOpen) return;
      isModalOpen = true;
      document.getElementById("route-modal").classList.add("active");

      // Update Message
      const msgEl = document.getElementById("modal-status-msg");
      if (message) {
        msgEl.innerText = "// " + message;
        msgEl.style.display = "block";
      } else {
        msgEl.style.display = "none";
      }

      // Reset state
      selectedMode = null;
      document.querySelectorAll(".option-card").forEach(c => c.classList.remove("selected"));
      document.getElementById("calc-btn").disabled = true;
      document.getElementById("processing-view").classList.remove("active");
    }

    function hideRouteModal() {
      isModalOpen = false;
      document.getElementById("route-modal").classList.remove("active");
    }

    function selectOption(mode, card) {
      selectedMode = mode;

      // Update UI
      document.querySelectorAll(".option-card").forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");

      document.getElementById("calc-btn").disabled = false;
    }

    function calculateRoute() {
      if (!selectedMode) return;

      // Show processing
      const overlay = document.getElementById("processing-view");
      const text = document.getElementById("processing-text");
      overlay.classList.add("active");

      // Simulation steps
      text.innerText = "ANALYZING TOPOLOGY...";

      setTimeout(() => {
        text.innerText = "OPTIMIZING COST FUNCTION...";
      }, 800);

      setTimeout(() => {
        text.innerText = "GENERATING TRAJECTORY...";
      }, 1600);

      setTimeout(() => {
        // Apply Mode
        setRoute(selectedMode);
        hideRouteModal();
      }, 2400);
    }

    // Trigger on Load
    setTimeout(() => showRouteModal("SYSTEM INITIALIZED"), 1000);

    function updateAgentPosition(status) {
      const agent = document.getElementById("agent");

      // Visual Coordinates for the "Illusion"
      // We now use the SVG paths themselves which are trimmed to Home/Target
      const pathId = routes[activeMode].id;
      const pathEl = document.getElementById(pathId);

      let svgX = 20; // Default Home
      let svgY = 780;
      let angleDeg = 0;

      // Check if we have a valid route to interpolate
      if (status.home && status.destination && status.current_pose && pathEl) {
        // Calculate Physical Distances
        const dx = status.destination.x - status.home.x;
        const dy = status.destination.y - status.home.y;
        const totalDist = Math.sqrt(dx * dx + dy * dy);

        const curDx = status.current_pose.x - status.home.x;
        const curDy = status.current_pose.y - status.home.y;
        const currentDist = Math.sqrt(curDx * curDx + curDy * curDy);

        // Calculate Progress Ratio (0.0 to 1.0)
        let progress = 0;
        if (totalDist > 0.01) {
          progress = currentDist / totalDist;
        }

        // Clamp Progress
        if (progress < 0) progress = 0;
        if (progress > 1) progress = 1;

        // Override if flags are set
        if (status.home_reached) progress = 0;
        if (status.dest_reached) progress = 1;

        // Trigger Modal on Arrival (Debounced)
        if ((status.home_reached || status.dest_reached) && !isModalOpen) {
          // Only trigger if we haven't just triggered it
          // Simple check: if progress is 0 or 1 and we are "stable"
          // Let's use a flag or just a timeout to prevent spam
          // For now, let's just trigger it once per arrival event?
          // Better: Check if we are "arrived" and the modal isn't open.
          // But we don't want it to pop up immediately if we just closed it.
          // Let's add a small delay check or just let the user close it.
          // Actually, the user wants it to ask "whenever we are starting or once we reach".
          // So if we reach, show it.

          // To avoid spamming while sitting at home:
          // We need a state "hasShownForCurrentArrival".
          // Let's keep it simple: if we are reached, show it. 
          // But if user closes it, don't show again until we leave and come back?
          // That requires more state.
          // Let's just show it once after a delay.
        }

        // Interpolate using SVG Path
        const len = pathEl.getTotalLength();
        const pt = pathEl.getPointAtLength(progress * len);

        svgX = pt.x;
        svgY = pt.y;

        // Calculate Rotation (Tangent)
        let nextPt;
        if (progress < 0.99) {
          nextPt = pathEl.getPointAtLength(Math.min((progress + 0.01) * len, len));
          angleDeg = Math.atan2(nextPt.y - pt.y, nextPt.x - pt.x) * (180 / Math.PI);
        } else {
          const prevPt = pathEl.getPointAtLength(Math.max((progress - 0.01) * len, 0));
          angleDeg = Math.atan2(pt.y - prevPt.y, pt.x - prevPt.x) * (180 / Math.PI);
        }

      } else if (status.current_pose) {
        // Fallback
        svgX = (status.current_pose.x * MAP_SCALE) + 20;
        svgY = (-status.current_pose.y * MAP_SCALE) + 780;
        angleDeg = -status.current_pose.yaw * (180 / Math.PI);
      } else {
        return;
      }

      agent.setAttribute("transform", `translate(${svgX}, ${svgY}) rotate(${angleDeg})`);

      // 4. Update Markers (Fixed for Illusion)
      // updateMarker("marker-home", status.home, "fa-home", "#ffcc00");
      // updateMarker("marker-dest", status.destination, "fa-map-marker-alt", "#00aaff");

      // 5. Update Status Chip for Arrival
      const chip = document.getElementById("map-status-chip");
      if (status.home_reached) {
        chip.innerHTML = '<i class="fas fa-check-circle"></i> HOME REACHED';
        chip.style.color = "#ffcc00";
        chip.style.borderColor = "#ffcc00";

        // Trigger Modal if not recently shown
        if (!window.hasShownHomeModal) {
          setTimeout(() => showRouteModal("SAFELY ARRIVED AT HOME"), 1000);
          window.hasShownHomeModal = true;
          window.hasShownDestModal = false; // Reset other
        }

      } else if (status.dest_reached) {
        chip.innerHTML = '<i class="fas fa-flag-checkered"></i> TARGET REACHED';
        chip.style.color = "#00aaff";
        chip.style.borderColor = "#00aaff";

        if (!window.hasShownDestModal) {
          setTimeout(() => showRouteModal("SAFELY ARRIVED AT DESTINATION"), 1000);
          window.hasShownDestModal = true;
          window.hasShownHomeModal = false; // Reset other
        }

      } else {
        if (!chip.innerHTML.includes("HIGH RISK")) {
          chip.innerHTML = '<i class="fas fa-shield-alt"></i> ROUTE STABLE';
          chip.style.color = "var(--accent-safe)";
          chip.style.borderColor = "rgba(255,255,255,0.1)";

          // Reset flags when moving
          window.hasShownHomeModal = false;
          window.hasShownDestModal = false;
        }
      }
    }

    function updateMarker(id, pos, iconClass, color) {
      let marker = document.getElementById(id);

      if (!pos) {
        if (marker) marker.style.display = "none";
        return;
      }

      if (!marker) {
        // Create marker if not exists
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.id = id;
        g.innerHTML = `<circle r="10" fill="${color}" opacity="0.3"/><text x="-6" y="4" font-family="FontAwesome" fill="white" font-size="12">&#xf015;</text>`;
        // Note: FontAwesome inside SVG text is tricky, using simple circle for now or need unicode
        // Let's use a simple circle with color
        g.innerHTML = `<circle r="8" fill="${color}" stroke="white" stroke-width="2"/>`;
        document.getElementById("nav-map").appendChild(g);
        marker = g;
      }

      marker.style.display = "block";
      const svgX = (pos.x * MAP_SCALE) + MAP_OFFSET_X;
      const svgY = (-pos.y * MAP_SCALE) + MAP_OFFSET_Y;
      marker.setAttribute("transform", `translate(${svgX}, ${svgY})`);
    }

    function drawAI(data) {
      // Match canvas to video size
      if (img.clientWidth && img.clientHeight) {
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (data.objects) {
        ctx.strokeStyle = "#15ffb9";
        ctx.lineWidth = 2;
        ctx.font = "bold 12px 'Space Mono'";

        data.objects.forEach(obj => {
          const [nx1, ny1, nx2, ny2] = obj.bbox;
          const x = nx1 * canvas.width;
          const y = ny1 * canvas.height;
          const w = (nx2 - nx1) * canvas.width;
          const h = (ny2 - ny1) * canvas.height;

          ctx.strokeRect(x, y, w, h);
          ctx.fillStyle = "#15ffb9";
          ctx.fillText(`${obj.label} ${Math.round(obj.conf * 100)}%`, x, y - 5);
        });
      }
    }

    connectWS();
    // animateAgentLoop(); // Disabled in favor of real data

  </script>
</body>

</html>